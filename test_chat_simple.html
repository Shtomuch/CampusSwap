<!DOCTYPE html>
<html>
<head>
    <title>Test Chat Simple</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
</head>
<body>
    <h1>Test Chat Simple</h1>
    <div id="status">Connecting...</div>
    <div id="logs"></div>
    <button onclick="sendTestMessage()">Send Test Message</button>
    
    <script>
        const status = document.getElementById('status');
        const logs = document.getElementById('logs');
        let connection = null;
        let accessToken = null;
        
        function log(message) {
            logs.innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + message + '</p>';
        }
        
        async function login() {
            try {
                const loginData = {
                    email: 'testuser@example.com',
                    password: 'Test123!'
                };
                
                const response = await fetch('http://localhost:5001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    accessToken = result.AccessToken;
                    log('‚úÖ Login successful');
                    return true;
                } else {
                    log('‚ùå Login failed: ' + response.status);
                    return false;
                }
            } catch (error) {
                log('‚ùå Login error: ' + error.message);
                return false;
            }
        }
        
        async function testChat() {
            try {
                // –°–ø–æ—á–∞—Ç–∫—É –ª–æ–≥—ñ–Ω–∏–º–æ—Å—è
                const loginSuccess = await login();
                if (!loginSuccess) {
                    status.textContent = 'Login failed';
                    return;
                }
                
                // –°—Ç–≤–æ—Ä—é—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Ç–æ–∫–µ–Ω–æ–º
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("http://localhost:5001/hubs/chat", {
                        accessTokenFactory: () => accessToken
                    })
                    .build();
                
                connection.onclose((error) => {
                    log('Connection closed: ' + error);
                });
                
                connection.onreconnecting((error) => {
                    log('Reconnecting: ' + error);
                });
                
                connection.onreconnected((connectionId) => {
                    log('Reconnected: ' + connectionId);
                });
                
                // –°–ª—É—Ö–∞—î–º–æ –ø–æ–º–∏–ª–∫–∏
                connection.on("Error", (error) => {
                    log('‚ùå SignalR Error: ' + error);
                });
                
                // –°–ª—É—Ö–∞—î–º–æ —Ä–æ–∑–º–æ–≤–∏
                connection.on("ConversationsLoaded", (conversations) => {
                    log('‚úÖ Conversations loaded: ' + JSON.stringify(conversations));
                });
                
                // –°–ª—É—Ö–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                connection.on("ReceiveMessage", (message) => {
                    log('‚úÖ Message received: ' + JSON.stringify(message));
                });
                
                // –°–ª—É—Ö–∞—î–º–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
                connection.on("MessageSent", (message) => {
                    log('‚úÖ Message sent confirmation: ' + JSON.stringify(message));
                });
                
                // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—è
                await connection.start();
                log('‚úÖ Connected to SignalR hub');
                status.textContent = 'Connected';
                
                // –¢–µ—Å—Ç—É—î–º–æ –≤–∏–∫–ª–∏–∫ –º–µ—Ç–æ–¥—É
                try {
                    await connection.invoke("GetConversations");
                    log('‚úÖ GetConversations called successfully');
                } catch (error) {
                    log('‚ùå GetConversations failed: ' + error.message);
                }
                
            } catch (error) {
                log('‚ùå Connection failed: ' + error.message);
                status.textContent = 'Failed: ' + error.message;
            }
        }
        
        async function sendTestMessage() {
            if (!connection) {
                log('‚ùå No connection available');
                return;
            }
            
            try {
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                const recipientId = 'b6ce1662-7309-4d30-b1ba-313eb649fa5c'; // –Ü–Ω—à–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
                const message = 'Test message from ' + new Date().toLocaleTimeString();
                
                log('üì§ Sending message to: ' + recipientId);
                log('üì§ Message: ' + message);
                
                await connection.invoke("SendMessage", recipientId, message);
                log('‚úÖ SendMessage called successfully');
                
            } catch (error) {
                log('‚ùå SendMessage failed: ' + error.message);
                log('‚ùå Error details: ' + JSON.stringify(error));
            }
        }
        
        testChat();
    </script>
</body>
</html>
